<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/edit.css" />
    <script src="js/url_handler.js"></script>
    <!-- 引入jQuery依赖 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- 引入editor.md的依赖，路径不同，写法不同 -->
    <!-- 一个css 三个js -->
    <link rel="stylesheet" href="editor.md/css/editormd.min.css" />
    <script src="editor.md/lib/marked.min.js"></script>
    <script src="editor.md/lib/prettify.min.js"></script>
    <script src="editor.md/editormd.js"></script>
    <link rel="icon" href="img/logo1.png" type="image/x-icon" />
    <title>写文章</title>
  </head>
  <body>
    <div class="navigation">
      <!-- 头像 -->
      <img src="img/logo1.png" />
      <div class="title">我的博客系统</div>

      <div class="space"></div>
      <a href="blog_lists.html">主页</a>
      <a href="myblog_lists.html">我的博客</a>
      <a href="/user/logout">退出登录</a>
    </div>
    <div class="blog-edit-container">
      <!-- 标题编辑区 -->
      <div id="form">
        <div class="title">
          <input type="text" id="text" />
          <input type="text" id="summary" style="display: none" />
          <input type="button" id="submit" value="提交" onclick="update()" />
        </div>
        <!-- 创建一个id为editor的div id！-->
        <div id="editor">
          <textarea id="content" style="display: none"></textarea>
        </div>
      </div>
    </div>
    <script>
      // editormd函数构造编辑器对象，参数则是编辑器元素的id，以及js对象，初始化量
      // 这一步重点在于默默帮你构建了对象！
      //其他属性在这里设置就行了，因为这里的优先级会更高！
      //由于不能有-号，所以圆角矩形不能在这里设置
      // 这个构造器，默认会溢出将滚动条给markdown编辑器！
      var editor = editormd("editor", {
        width: "100%",
        height: "calc(100% - 50px)",
        markdown: "# 在这里写下一篇博客",
        path: "editor.md/lib/",
        saveHTMLToTextarea: true,
      });
      var aid = getParamValue("aid");
      // 1. 校验参数
      function init() {
        if (aid == null || aid <= 0) {
          alert("非法参数！");
          location.href = "myblog_lists.html";
          return false;
        }
        // 2. 查询文章
        jQuery.ajax({
          url: "/art/get_art",
          method: "post",
          contentType: "application/json; charset=utf8",
          data: JSON.stringify({
            id: aid,
          }),
          success: function (body) {
            if (body.code == 302) {
              alert("抱歉，请先登录！");
              location.href = body.msg;
              return false;
            }
            if (body.code == 200) {
              jQuery("#text").val(body.data.title);
              jQuery("#content").val(body.data.content);
              jQuery("#summary").val(body.data.summary);
            } else {
              alert("发布失败：" + body.msg);
            }
          },
        });
      }
      init();
      function update() {
        if (aid == null || aid <= 0) {
          alert("非法参数！");
          location.href = "myblog_lists.html";
          return false;
        }
        var title = jQuery("#text");
        var content = jQuery("#content");
        // 1. 参数校验
        if (title.val().trim() == "") {
          alert("标题不能为空！");
          title.focus();
          return false;
        }
        if (content.val().trim() == "") {
          alert("正文不能为空！");
          content.focus();
          return false;
        }
        // 2. 输入摘要
        var summary = prompt("请输入摘要：", jQuery("#summary").val());
        if (summary.trim() == "") {
          alert("摘要不能为空！");
          return false;
        }
        jQuery("#summary").val(summary);
        // 3. 发送请求
        jQuery.ajax({
          url: "/art/update",
          method: "POST",
          contentType: "application/json; charset=utf8",
          data: JSON.stringify({
            id: aid,
            title: title.val().trim(),
            content: content.val().trim(),
            summary: summary.trim(),
          }),
          // 3. 处理响应
          success: function (body) {
            if (body.code == 302) {
              alert("抱歉，请先登录！");
              location.href = body.msg;
              return false;
            }
            if (body.code == 200 && body.data == 1) {
              location.href = "myblog_lists.html";
            } else {
              alert("修改失败：" + body.msg);
            }
          },
        });
      }
    </script>
  </body>
</html>
