<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/common.css" />
    <link rel="stylesheet" href="./css/list.css" />
    <link rel="stylesheet" href="./css/pursue.css" />
    <link rel="stylesheet" href="./dist/css/jquery.toast.css" />
    <link rel="icon" href="./img/logo.png" type="image/x-icon" />
    <title>ç­çº§æ¶ˆæ¯</title>
</head>
<body>
<div class="navigation">
    <div class="space1" style="display: flex; justify-content: flex-start">
        <img src="./img/logo.png"/>
        <div id="title">å®¶æ ¡é€š Â· ç­çº§æ¶ˆæ¯ï¼ˆ<span id="userNickname"></span>ï¼‰</div>
    </div>
    <div class="space2" style="display: flex; justify-content: flex-end">
        <a href="./my_class_list.html">æˆ‘çš„ç­çº§</a>
        <a href="./class_list.html">ç­çº§åˆ—è¡¨</a>
        <a href="./site_message_list.html">ç«™å†…ä¿¡</a>
        <a href="./system_message_list.html">ç³»ç»Ÿæ¶ˆæ¯</a>
        <a href="./login.html">ç™»å½•</a>
    </div>
</div>
<div class="container">
    <div class="container-right" style="width: 100%">
        <div class="article" style="height: 90%">
            <div id="a"></div>
        </div>
        <div class="blog-pagnation-wrapper">
            <div class="row">
                <label for="class">ç­çº§</label>
                <select id="class">
                    <option style='display: none'></option>
                </select>
            </div>
            <div class="row">
                <label for="isFromMe">ğŸ‘‰</label>
                <select id="isFromMe">
                    <option value="false">å…¨éƒ¨</option>
                    <option value="true">æˆ‘å‘å¸ƒçš„</option>
                </select>
            </div>
            <button class="blog-pagnation-item" onclick="tofirst()">é¦–é¡µ</button>
            <button class="blog-pagnation-item" onclick="toPrev()">ä¸Šä¸€é¡µ</button>
            <button class="blog-pagnation-item" onclick="toNext()">ä¸‹ä¸€é¡µ</button>
            <button class="blog-pagnation-item" onclick="toLast()">æœ«é¡µ</button>
            <div class="row">
                <label for="current">å½“å‰é¡µç </label>
                <input type="text" id="current" name="current"/>
                <label for="current">å…± <span id="pages"></span> é¡µ</label>
            </div>
            <div class="row">
                <label for="pageSize">é¡µå†…æ¡æ•°</label>
                <input type="text" id="pageSize" name="pageSize" />
                <label for="pageSize">å…± <span id="total"></span> æ¡</label>
            </div>
        </div>
    </div>
</div>
<!-- å¯¼å…¥JS -->
<script src="./dist/js/jquery-3.6.3.js"></script>
<script src="./dist/js/jquery.cookie.js"></script>
<script src="./dist/js/jquery.toast.js"></script>
<script src="./js/urlHandler.js"></script>
<script src="./js/redirect.js"></script>
<script src="./js/token.js"></script>
<script src="./js/request.js"></script>
<script>

    jsonRequestWithToken("/api/v1/user/info", "GET", null, function (data) {
        jQuery("#userNickname").html(data.nickname);
    });

    function getMinhIndex(arr, val) {
        for (var i = 0; i < arr.length; i++) {
            if (arr[i] === val) {
                return i;
            }
        }
    }

    function waterFall(boxes) {
        // å°†aä¸‹çš„å…¨éƒ¨boxå–å‡ºæ¥
        var oParent = jQuery("#a");
        // è®¡ç®—æ˜¾ç¤ºçš„åˆ—æ•°ï¼ˆé¡µé¢çš„å®½/boxçš„å®½ï¼‰
        var oBoxWeight = boxes[0].outerWidth(); // console.log(oBoxWeight);
        //333 + å†…è¾¹è· 10 * 2 + è¾¹æ¡† 1 * 2 + ï¼ˆå¡«å……ï¼‰15 == 370
        var cols = Math.floor(jQuery("#a").width() / oBoxWeight);
        // è®¾ç½®açš„å®½åº¦
        oParent.css("width", cols * oBoxWeight + "px");
        oParent.css("margin", "0 auto");

        // å­˜æ”¾ç¬¬è¯¥åˆ—ï¼ˆä½ç½®æ­£ç¡®æ‘†æ”¾çš„å¤šä¸ªdivé«˜åº¦ï¼‰çš„é«˜åº¦çš„æ•°ç»„
        // ç¬¬ä¸€æ¬¡ï¼Œåˆ™æ˜¯ç¬¬ä¸€è¡Œæ¯ä¸ªdivçš„é«˜åº¦
        var hArr = [];
        for (var i = 0; i < boxes.length; i++) {
            if (i < cols) {
                hArr.push(boxes[i].outerHeight());
            } else {
                var minH = Math.min.apply(null, hArr); //top
                var index = getMinhIndex(hArr, minH);
                boxes[i].attr(
                    "style",
                    "position: absolute; top: " +
                    minH +
                    "px; left: " +
                    oBoxWeight * index +
                    "px;"
                );
                //å¤„ç†ç›’å­é‡å 
                hArr[index] += boxes[i].outerHeight();
            }
        }
        // left -> å·¦è¾¹ä¸‰ä¸ªdivçš„å®½ï¼Œtop-> æœ€å°é«˜
    }

    function buildBox(createTime, title, messageId) {
        var result = "<br/><h2>" + title + "</h2>";
        var aB = jQuery("<div></div>");
        aB.attr("class", "B");
        aB.append(result);
        var aTleft = jQuery("<div></div>");
        aTleft.attr("class", "Tleft");
        var aTright = jQuery("<div></div>");
        aTright.attr("class", "Tright");
        aTright.append("<h4>" + createTime + "</h4>");
        var aT = jQuery("<div></div>");
        aT.attr("class", "T");
        aT.append(aTleft);
        aT.append(aTright);
        var aPic = jQuery("<div></div>");
        aPic.attr("class", "pic");
        aPic.append(aT);
        aPic.append(aB);
        var aBox = jQuery(
            "<a href='./class_message_detail.html?messageId=" +
            messageId +
            "'></a>"
        );
        aBox.attr("class", "box");
        aPic.appendTo(aBox);
        aBox.appendTo(jQuery("#a"));
        return aBox;
    }

    jsonRequestWithToken("/api/v1/class/query/self", "GET", null, function (data) {
        if(data.length < 1) {
            jQuery.toast({
                heading: "æé†’",
                text: "å°šæœªåŠ å…¥è¿‡ç­çº§",
                icon: "info",
                allowToastClose: true,
            });
            return false;
        }
        for (i = 0; i < data.length; i++) {
            var item = data[i];
            if(i === 0) {
                jQuery("#class").append(jQuery('<option value="' + item.id + '" selected="selected">' + item.className + '</option>'));
            }else {
                jQuery("#class").append(jQuery('<option value="' + item.id + '">' + item.className + '</option>'));
            }
        }
        queryClassMessage();
    })

    function queryClassMessage() {
        jQuery("#a").empty();
        var classId = jQuery("#class");
        if(!classId.val()) {
            jQuery.toast({
                heading: "æé†’",
                text: "è¯·é€‰æ‹©ç­çº§",
                icon: "warning",
                allowToastClose: true,
            });
            classId.focus();
            return false;
        }
        jsonRequestWithToken(
            "/api/v1/message/class/query",
            "POST",
            {
                current: jQuery("#current").val(),
                pageSize: jQuery("#pageSize").val(),
                classId: classId.val(),
                isFromMe: jQuery("#isFromMe").val(),
            },
            function (data) {
                jQuery("#current").val(data.current);
                jQuery("#pages").html(data.pages);
                jQuery("#pageSize").val(data.pageSize);
                jQuery("#total").html(data.total);
                var boxArray = [];
                var resultList = data.list;
                for (i = 0; i < resultList.length; i++) {
                    var item = resultList[i];
                    boxArray.push(buildBox(item.createTime, item.title, item.id));
                }
                waterFall(boxArray);
            }
        );
    }

    jQuery("#class").change(queryClassMessage);
    jQuery("#isFromMe").change(queryClassMessage);
    jQuery("#current").blur(queryClassMessage);
    jQuery("#pageSize").blur(queryClassMessage);

    function tofirst() {
        jQuery("#current").val(1);
        queryClassMessage();
    }
    function toLast() {
        jQuery("#current").val(jQuery("#pages").html());
        queryClassMessage();
    }
    function toPrev() {
        jQuery("#current").val(Number(jQuery("#current").val()) - 1);
        queryClassMessage();
    }
    function toNext() {
        jQuery("#current").val(Number(jQuery("#current").val()) + 1);
        queryClassMessage();
    }
</script>
</body>
</html>
